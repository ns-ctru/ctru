---
title: "CTRU Cluster Randomisation"
author: "n.shephard@sheffield.ac.uk"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{CTRU Cluster Randomisation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

[Sheffield Clinical Trials Research Unit](https://www.sheffield.ac.uk/scharr/sections/dts/ctru) conducts clinical trials of different medical and therapeautic interventions.  The Standard Operating Procedures (SOPs) state that work should be conducted in a reproducible manner to which end software such as [R](https://www.r-project.org) or [Stata](https://www.stata.com/) are employed to conduct statistical analyses using the principles of [Reproducibility](https://en.wikipedia.org/wiki/Reproducibility) using scripts and dynamic reporting such as [RMarkdown](http://rmarkdown.rstudio.com/).  Many of the tasks involve randomisation of participants to treatment interventions, and whilst a 'bespoke' system for individual randomisation has been purchased from  [EpiGensys](https://www.epigenesys.org.uk/) cluster randomisation, whereby the unit of randomisation is not individuals, but instead one of therapist, institution or some other form of grouping is not covered by the system and this is instead performed manually.

This document details the procedures used in deriving a cluster randomisation list for use in studies that are not individually randomised.

## Packages

In R the package `[blockrand](https://cran.r-project.org/web/packages/blockrand/index.html)` provides functionality for deriving randomisation lists and these can be applied to clustered study designs.  The main function provided by the package is `blockrand()` and it has a wide range of options that users may choose from (these are not repeated here and readers are instead directed to the [packages reference manual](s://cran.r-project.org/web/packages/blockrand/blockrand.pdf)).

### `blockrand()` Usage

Usage is described in the [packages reference manual](s://cran.r-project.org/web/packages/blockrand/blockrand.pdf), to aid working through this a worked example is provided.

A cluster randomsied study is being initiated with two arms (`case` and `control`).  The centers are hospitals and there are to be three stratum based on the size of the institution (`small`, `medium` or `large`) and it is expected that there will be plenty of `small` and `medium` but very few `large` so the block sizes for this group will be kept small to ensure balance.  The overall aim is to recruit 130 centres in total.  The parameters are summarised in the table below...


The following code generates the randomisation list...

```{r randomisation, cache = FALSE, echo = TRUE, warnings = FALSE, results = 'hide', eval = TRUE}
## Load librarys
library(blockrand)
library(tidyverse)
## Set a seed for pseudo-random number generation to ensure the list can be regenerated
##
## If you struggle to come up with a seed take a bank note out of your pocket and use the
## numbers from the serial code on it
set.seed(9855468732)
## Set parameters
n           <- 80  ## Purposefully large
num_levels  <- 2   ## Case and Control stratum
## Generate randomisation for small stratum
block_sizes <- 4   ## Blocks of random size up to 4
small       <- blockrand(n            = n,
                         num.levels   = num_levels,
                         levels       = c('Case', 'Control'),
                         id.prefix    = 'HOSP',
                         stratum      = 'Small',
                         block.sizes  = block_sizes)
## Generate randomisation for medium stratum
block_sizes <- 4   ## Blocks of random size up to 4
medium      <- blockrand(n          = n,
                         num.levels = num_levels,
                         levels     = c('Case', 'Control'),
                         id.prefix = 'HOSP',
                         stratum    = 'Medium',
                         block.sizes = block_sizes)
## Generate randomsiation for large stratum
block_sizes <- 1  ## Blocks of size 1 as few large centres are expected and could cause imbalance
large       <- blockrand(n          = n,
                         num.levels = num_levels,
                         levels     = c('Case', 'Control'),
                         id.prefix = 'HOSP',
                         stratum    = 'Large',
                         block.sizes = block_sizes)
## Bind the three lists together
randomisation <- rbind(small,
                       medium,
                       large)
## Derive a unique identifier across all stratum
randomisation <- randomisation %>%
                 mutate(row = rownames(.),
                        id = case_when(nchar(row) == 1 ~ paste0('HOSP', '00', row),
                                       nchar(row) == 2 ~ paste0('HOSP', '0', row),
                                       nchar(row) == 3 ~ paste0('HOSP', row))) %>%
                 dplyr::select(-row)

```
You may wish to plot the distribution of allocations within each stratum to ensure equipoise (balance) within each, the following code achieves this...


```{r results_schedule_plot, cache = FALSE, echo = TRUE, warnings = FALSE, results = 'hide', eval = TRUE}
## Plot the distribution of randomisation by stratum
ggplot(randomisation,
        aes(x    = stratum,
            fill = treatment)) +
    geom_histogram(stat     = "count",
                   position = "dodge") +
    xlab('Stratum') +
    ylab('Number allocated') +
    labs(fill = 'Treatment Allocation') +
    theme_bw()

```

Once the list has been generated it can be sent to whomever is to use it.  A useful feature though is to upload it to Google Sheets for others to use and this can be acheived using the `[googlesheets](https://cran.r-project.org/web/packages/googlesheets/)` packages.  The first time you run this you will be asked to authorise and permit R/`googlesheets` to your Google Drive.  For more information on this please refer to the [googlesheets Basic Usage vignette](https://rawgit.com/jennybc/googlesheets/master/vignettes/basic-usage.html)

```{r upload_to_googlesheets, cache = FALSE, echo = TRUE, warnings = FALSE, results = 'hide', eval = TRUE}
## Write the randomisation file to CSV and upload to GoogleSheets
## First add in an extra blank column for hospital name to be recorded in
randomisation$hospital <- ""
file <- 'randomisation.csv'
write.csv(randomisation,
          file = file,
          row.names = FALSE)
gs_upload(file = file,
          sheet_title = 'iSocialise Randomisation Schedule',
          overwrite   = TRUE)


```
